<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video + Sensor Recorder</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #fff8f0; }
    video { width: 90%; max-width: 500px; margin-top: 1rem; border: 2px solid #333; border-radius: 10px; }
    button { margin: 1rem; padding: 1rem; font-size: 1rem; border-radius: 8px; }
    #enableSensorsBtn { background: #4CAF50; color: white; }
    .banner { background: #ff6600; color: white; padding: 0.5rem; font-weight: bold; }
  </style>
</head>
<body>
  <div class="banner">v3 â€“ iOS Video Fix (no mic)</div>

  <h2>Video + Sensor Recorder</h2>
  <video id="preview" autoplay playsinline muted></video><br>
  <button id="enableSensorsBtn">Enable Sensors</button><br>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <div id="downloads"></div>

  <script>
    let mediaRecorder, recordedChunks = [];
    let sensorData = [];
    let recording = false;

    const video = document.getElementById("preview");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const downloads = document.getElementById("downloads");
    const enableBtn = document.getElementById("enableSensorsBtn");

    async function initCamera() {
      try {
        // Disable audio to avoid mic feedback
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;

        // Use MIME type that iOS Safari prefers
        const options = { mimeType: "video/mp4" };
        mediaRecorder = new MediaRecorder(stream, options);

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          // Save video
          const blob = new Blob(recordedChunks, { type: "video/mp4" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recording.mp4"; // better for iOS
          a.textContent = "Download Video";
          downloads.appendChild(a);
          downloads.appendChild(document.createElement("br"));

          // Save sensor data CSV
          let csv = "timestamp,ax,ay,az,gx,gy,gz\n";
          sensorData.forEach(d => {
            csv += `${d.t},${d.ax},${d.ay},${d.az},${d.gx},${d.gy},${d.gz}\n`;
          });
          const blobCSV = new Blob([csv], { type: "text/csv" });
          const urlCSV = URL.createObjectURL(blobCSV);
          const a2 = document.createElement("a");
          a2.href = urlCSV;
          a2.download = "sensors.csv";
          a2.textContent = "Download Sensor Data";
          downloads.appendChild(a2);
        };
      } catch (err) {
        alert("Camera access denied: " + err);
      }
    }

    function initSensors() {
      if (typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function") {
        enableBtn.style.display = "inline-block";
        enableBtn.onclick = () => {
          DeviceMotionEvent.requestPermission().then(response => {
            if (response === "granted") {
              window.addEventListener("devicemotion", logMotion);
              enableBtn.style.display = "none";
            } else {
              alert("Motion permission denied");
            }
          });
        };
      } else {
        window.addEventListener("devicemotion", logMotion);
        enableBtn.style.display = "none";
      }
    }

    function logMotion(event) {
      if (recording) {
        const t = Date.now();
        const ax = event.acceleration.x || 0;
        const ay = event.acceleration.y || 0;
        const az = event.acceleration.z || 0;
        const gx = event.rotationRate.alpha || 0;
        const gy = event.rotationRate.beta || 0;
        const gz = event.rotationRate.gamma || 0;
        sensorData.push({ t, ax, ay, az, gx, gy, gz });
      }
    }

    startBtn.onclick = () => {
      recordedChunks = [];
      sensorData = [];
      mediaRecorder.start();
      recording = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      downloads.innerHTML = "";
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recording = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    initCamera();
    initSensors();
  </script>
</body>
</html>
