<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video + Sensor Recorder</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9f9f9; }
    video { width: 90%; max-width: 500px; margin-top: 1rem; border: 2px solid #333; border-radius: 10px; }
    button { margin: 1rem; padding: 1rem; font-size: 1rem; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>Video + Sensor Recorder</h2>
  <video id="preview" autoplay playsinline></video><br>
  <button id="startBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>
  <div id="downloads"></div>

  <script>
    let mediaRecorder, recordedChunks = [];
    let sensorData = [];
    let recording = false;

    const video = document.getElementById("preview");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const downloads = document.getElementById("downloads");

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = () => {
          // Save video
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "recording.webm";
          a.textContent = "Download Video";
          downloads.appendChild(a);
          downloads.appendChild(document.createElement("br"));

          // Save sensor data CSV
          let csv = "timestamp,ax,ay,az,gx,gy,gz\n";
          sensorData.forEach(d => {
            csv += `${d.t},${d.ax},${d.ay},${d.az},${d.gx},${d.gy},${d.gz}\n`;
          });
          const blobCSV = new Blob([csv], { type: "text/csv" });
          const urlCSV = URL.createObjectURL(blobCSV);
          const a2 = document.createElement("a");
          a2.href = urlCSV;
          a2.download = "sensors.csv";
          a2.textContent = "Download Sensor Data";
          downloads.appendChild(a2);
        };
      } catch (err) {
        alert("Camera access denied: " + err);
      }
    }

    // Motion sensor handler
    function initSensors() {
      if (typeof DeviceMotionEvent.requestPermission === "function") {
        // iOS requires permission
        DeviceMotionEvent.requestPermission().then(response => {
          if (response === "granted") {
            window.addEventListener("devicemotion", event => {
              if (recording) {
                const t = Date.now();
                const ax = event.acceleration.x || 0;
                const ay = event.acceleration.y || 0;
                const az = event.acceleration.z || 0;
                const gx = event.rotationRate.alpha || 0;
                const gy = event.rotationRate.beta || 0;
                const gz = event.rotationRate.gamma || 0;
                sensorData.push({ t, ax, ay, az, gx, gy, gz });
              }
            });
          }
        });
      } else {
        // Non-iOS browsers
        window.addEventListener("devicemotion", event => {
          if (recording) {
            const t = Date.now();
            const ax = event.acceleration.x || 0;
            const ay = event.acceleration.y || 0;
            const az = event.acceleration.z || 0;
            const gx = event.rotationRate.alpha || 0;
            const gy = event.rotationRate.beta || 0;
            const gz = event.rotationRate.gamma || 0;
            sensorData.push({ t, ax, ay, az, gx, gy, gz });
          }
        });
      }
    }

    startBtn.onclick = () => {
      recordedChunks = [];
      sensorData = [];
      mediaRecorder.start();
      recording = true;
      startBtn.disabled = true;
      stopBtn.disabled = false;
      downloads.innerHTML = "";
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      recording = false;
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    initCamera();
    initSensors();
  </script>
</body>
</html>
